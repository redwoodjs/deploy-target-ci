name: üç∞ Deploy Layer0 

on:
  push:
    branches: [main]
    paths: [
      'layer0/**',
      '.github/workflows/deploy-layer0.yml'
    ]

jobs:
  deploy-layer0:
    if: github.repository == 'redwoodjs/deploy-target-ci'

    name: üç∞ Deploy Layer0 
    runs-on: ubuntu-latest

    env:
      REDWOOD_CI: 1    

    defaults:
      run:
        working-directory: ./layer0

    steps:
      - uses: actions/checkout@v3

      # - name: Enable Corepack
      #   run: corepack enable

      - name: ‚¨¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üêà Yarn install
        run: yarn install --inline-builds
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # TODO change to `rw deploy layer0` when implemented
      - name: üöÄ Deploy
        run: yarn layer0:deploy --site=redwoodjs-deploy-target-ci --team=redwoodjs --ni --token=$deploy_token
        env:
          deploy_token: ${{ secrets.LAYER0_DEPLOY_TOKEN }}

  message-slack:
    needs: deploy-layer0
    if: always()

    name: üí¨ Message Slack
    runs-on: ubuntu-latest

    steps:
      - name: Get `deploy_status`
        run: |
          RW_DEPLOY_STATUS=$(echo '{
            "failure": "Deploy failed üö®",
            "success": "Deploy successful ‚úÖ",
            "cancelled": "Deploy cancelled üîò",
            "skipped": "Deploy skipped üîò"
            }' | \
              jq -r .${{ needs.deploy-layer0.result }}
          )

          echo "RW_DEPLOY_STATUS=$RW_DEPLOY_STATUS" >> $GITHUB_ENV

      - name: Get `deploy_commit`
        run: |
          RW_DEPLOY_COMMIT=$(echo '${{ github.event.head_commit.message }}' | awk 'NR==1 {print}')
          echo "RW_DEPLOY_COMMIT=$RW_DEPLOY_COMMIT" >> $GITHUB_ENV

      - name: üí¨ Message Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "deploy_target": "Layer0 üç∞",
              "deploy_status": "$RW_DEPLOY_STATUS",
              "deploy_commit": "$RW_DEPLOY_COMMIT"
            }            
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
